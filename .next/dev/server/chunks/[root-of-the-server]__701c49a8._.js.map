{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///home/ayan/Programming/NextFasterPostgres/src/lib/unstable-cache.ts"],"sourcesContent":["import { unstable_cache as next_unstable_cache } from \"next/cache\";\nimport { cache } from \"react\";\n\n// next_unstable_cache doesn't handle deduplication, so we wrap it in React's cache\nexport const unstable_cache = <Inputs extends unknown[], Output>(\n  callback: (...args: Inputs) => Promise<Output>,\n  key: string[],\n  options: { revalidate: number },\n) => cache(next_unstable_cache(callback, key, options));\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGO,MAAM,iBAAiB,CAC5B,UACA,KACA,UACG,IAAA,gNAAK,EAAC,IAAA,iJAAmB,EAAC,UAAU,KAAK"}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///home/ayan/Programming/NextFasterPostgres/src/lib/session.ts"],"sourcesContent":["import { NewUser } from \"@/db/schema\";\nimport { compare, hash } from \"bcryptjs\";\nimport { SignJWT, jwtVerify } from \"jose\";\nimport { cookies } from \"next/headers\";\n\nconst key = new TextEncoder().encode(process.env.AUTH_SECRET);\nconst SALT_ROUNDS = 10;\n\nexport async function hashPassword(password: string) {\n  return hash(password, SALT_ROUNDS);\n}\n\nexport async function comparePasswords(\n  plainTextPassword: string,\n  hashedPassword: string,\n) {\n  return compare(plainTextPassword, hashedPassword);\n}\n\ntype SessionData = {\n  user: { id: number };\n  expires: string;\n};\n\nexport async function signToken(payload: SessionData) {\n  return await new SignJWT(payload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(\"1 day from now\")\n    .sign(key);\n}\n\nexport async function verifyToken(input: string) {\n  const { payload } = await jwtVerify(input, key, {\n    algorithms: [\"HS256\"],\n  });\n  return payload as SessionData;\n}\n\nexport async function getSession() {\n  const session = (await cookies()).get(\"session\")?.value;\n  if (!session) return null;\n  return await verifyToken(session);\n}\n\nexport async function setSession(user: NewUser) {\n  const expiresInOneDay = new Date(Date.now() + 24 * 60 * 60 * 1000);\n  const session: SessionData = {\n    user: { id: user.id! },\n    expires: expiresInOneDay.toISOString(),\n  };\n  const encryptedSession = await signToken(session);\n  (await cookies()).set(\"session\", encryptedSession, {\n    expires: expiresInOneDay,\n    httpOnly: true,\n    secure: true,\n    sameSite: \"lax\",\n  });\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AACA;AACA;AAAA;AACA;;;;AAEA,MAAM,MAAM,IAAI,cAAc,MAAM,CAAC,QAAQ,GAAG,CAAC,WAAW;AAC5D,MAAM,cAAc;AAEb,eAAe,aAAa,QAAgB;IACjD,OAAO,IAAA,2IAAI,EAAC,UAAU;AACxB;AAEO,eAAe,iBACpB,iBAAyB,EACzB,cAAsB;IAEtB,OAAO,IAAA,8IAAO,EAAC,mBAAmB;AACpC;AAOO,eAAe,UAAU,OAAoB;IAClD,OAAO,MAAM,IAAI,uKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,kBAClB,IAAI,CAAC;AACV;AAEO,eAAe,YAAY,KAAa;IAC7C,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO,KAAK;QAC9C,YAAY;YAAC;SAAQ;IACvB;IACA,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,UAAU,CAAC,MAAM,IAAA,4IAAO,GAAE,EAAE,GAAG,CAAC,YAAY;IAClD,IAAI,CAAC,SAAS,OAAO;IACrB,OAAO,MAAM,YAAY;AAC3B;AAEO,eAAe,WAAW,IAAa;IAC5C,MAAM,kBAAkB,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK;IAC7D,MAAM,UAAuB;QAC3B,MAAM;YAAE,IAAI,KAAK,EAAE;QAAE;QACrB,SAAS,gBAAgB,WAAW;IACtC;IACA,MAAM,mBAAmB,MAAM,UAAU;IACzC,CAAC,MAAM,IAAA,4IAAO,GAAE,EAAE,GAAG,CAAC,WAAW,kBAAkB;QACjD,SAAS;QACT,UAAU;QACV,QAAQ;QACR,UAAU;IACZ;AACF"}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///home/ayan/Programming/NextFasterPostgres/src/db/index.ts"],"sourcesContent":["// import * as schema from \"./schema\";\n// import { drizzle } from \"drizzle-orm/neon-http\";\n// import { neon } from \"@neondatabase/serverless\";\n//\n// const sql = neon(\n//   \"postgresql://neondb_owner:npg_A6mkNxw3uiZn@ep-dark-water-ahidvgxk-pooler.c-3.us-east-1.aws.neon.tech/neondb\",\n// );\n// export const db = drizzle({ client: sql, schema });\n//\n\nimport { Pool } from 'pg';\n\nconst pool = new Pool({\n  user: 'shujan',\n  host: 'localhost',\n  database: 'nextfaster',\n  password: 'shujan@786',\n  port: 5432,\n});\n\npool.on('connect', ()=>{\n  console.log('pool working');\n});\n\npool.on('error', (err)=>{\n  console.log(err.message);\n})\n\nexport default pool;\n"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,mDAAmD;AACnD,mDAAmD;AACnD,EAAE;AACF,oBAAoB;AACpB,mHAAmH;AACnH,KAAK;AACL,sDAAsD;AACtD,EAAE;;;;;AAEF;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,MAAM;IACN,MAAM;IACN,UAAU;IACV,UAAU;IACV,MAAM;AACR;AAEA,KAAK,EAAE,CAAC,WAAW;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,QAAQ,GAAG,CAAC,IAAI,OAAO;AACzB;uCAEe"}},
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///home/ayan/Programming/NextFasterPostgres/src/lib/queries.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport { unstable_cache } from \"./unstable-cache\";\nimport { verifyToken } from \"./session\";\nimport pool from \"@/db\";\n\n/* ----------------------------- USER ----------------------------- */\n\nexport async function getUser() {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get(\"session\");\n\n  if (!sessionCookie?.value) return null;\n\n  const sessionData = await verifyToken(sessionCookie.value);\n\n  if (\n    !sessionData?.user ||\n    typeof sessionData.user.id !== \"number\" ||\n    new Date(sessionData.expires) < new Date()\n  ) {\n    return null;\n  }\n\n  const { rows } = await pool.query(\n    `\n    SELECT id, username \n    FROM users\n    WHERE id = $1\n    `,\n    [sessionData.user.id],\n  );\n\n  return rows[0] ?? null;\n}\n\n/* ----------------------------- PRODUCTS ----------------------------- */\n\nexport const getProductsForSubcategory = unstable_cache(\n  async (subcategorySlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT *\n      FROM products\n      WHERE subcategory_slug = $1\n      ORDER BY slug ASC\n      `,\n      [subcategorySlug],\n    );\n    return rows;\n  },\n  [\"subcategory-products\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\nexport const getProductDetails = unstable_cache(\n  async (productSlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT *\n      FROM products\n      WHERE slug = $1\n      LIMIT 1\n      `,\n      [productSlug],\n    );\n    console.log(\"product details \" + rows[0]);\n    return rows[0] ?? null;\n  },\n  [\"product\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\n/* ----------------------------- COLLECTIONS ----------------------------- */\n\nexport const getCollections = unstable_cache(\n  async () => {\n    const { rows } = await pool.query(\n      `\n      SELECT\n        c.*,\n        COALESCE(\n          json_agg(cat.* ORDER BY cat.name)\n          FILTER (WHERE cat.slug IS NOT NULL),\n          '[]'\n        ) AS categories\n      FROM collections c\n      LEFT JOIN categories cat\n        ON cat.collection_id = c.id\n      GROUP BY c.id\n      ORDER BY c.name ASC\n      `,\n    );\n    console.log(\"collections \" + rows);\n    return rows;\n  },\n  [\"collections\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\nexport const getCollectionDetails = unstable_cache(\n  async (collectionSlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT\n        c.*,\n        COALESCE(\n          json_agg(cat.* ORDER BY cat.name)\n          FILTER (WHERE cat.slug IS NOT NULL),\n          '[]'\n        ) AS categories\n      FROM collections c\n      LEFT JOIN categories cat\n        ON cat.collection_id = c.id\n      WHERE c.slug = $1\n      GROUP BY c.id\n      `,\n      [collectionSlug],\n    );\n\n    console.log(\"collecion details \" + rows);\n    return rows;\n  },\n  [\"collection\"],\n  { revalidate: 60 * 60 * 2 },\n);\n/* ----------------------------- CATEGORIES ----------------------------- */\n\nexport const getCategory = unstable_cache(\n  async (categorySlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT\n        c.slug,\n        c.name,\n        c.image_url,\n        COALESCE(\n          json_agg(\n            json_build_object(\n              'id', sc.id,\n              'name', sc.name,\n              'subcategories', (\n                SELECT COALESCE(\n                  json_agg(\n                    json_build_object(\n                      'slug', s.slug,\n                      'name', s.name,\n                      'image_url', s.image_url\n                    )\n                    ORDER BY s.slug\n                  ),\n                  '[]'::json\n                )\n                FROM subcategories s\n                WHERE s.subcollection_id = sc.id\n              )\n            )\n            ORDER BY sc.name\n          ) FILTER (WHERE sc.id IS NOT NULL),\n          '[]'::json\n        ) AS subcollections\n      FROM categories c\n      LEFT JOIN subcollections sc\n        ON sc.category_slug = c.slug\n      WHERE c.slug = $1\n      GROUP BY c.slug, c.name, c.image_url\n      `,\n      [categorySlug],\n    );\n\n    return rows[0] ?? null;\n  },\n  [\"category\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\nexport const getSubcategory = unstable_cache(\n  async (subcategorySlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT *\n      FROM subcategories\n      WHERE slug = $1\n      LIMIT 1\n      `,\n      [subcategorySlug],\n    );\n    return rows[0] ?? null;\n  },\n  [\"subcategory\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\n/* ----------------------------- COUNTS ----------------------------- */\n\nexport const getProductCount = unstable_cache(\n  async () => {\n    const { rows } = await pool.query(\n      `SELECT COUNT(*)::int AS count FROM products`,\n    );\n    return rows[0].count;\n  },\n  [\"total-product-count\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\nexport const getCategoryProductCount = unstable_cache(\n  async (categorySlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT COUNT(p.*)::int AS count\n      FROM categories c\n      LEFT JOIN subcollections sc\n        ON sc.category_slug = c.slug\n      LEFT JOIN subcategories s\n        ON s.subcollection_id = sc.id\n      LEFT JOIN products p\n        ON p.subcategory_slug = s.slug\n      WHERE c.slug = $1\n      `,\n      [categorySlug],\n    );\n    return rows[0].count;\n  },\n  [\"category-product-count\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\nexport const getSubcategoryProductCount = unstable_cache(\n  async (subcategorySlug: string) => {\n    const { rows } = await pool.query(\n      `\n      SELECT COUNT(*)::int AS count\n      FROM products\n      WHERE subcategory_slug = $1\n      `,\n      [subcategorySlug],\n    );\n    return rows[0].count;\n  },\n  [\"subcategory-product-count\"],\n  { revalidate: 60 * 60 * 2 },\n);\n\n/* ----------------------------- SEARCH ----------------------------- */\n\nexport const getSearchResults = unstable_cache(\n  async (searchTerm: string) => {\n    const baseQuery = `\n      SELECT\n        p.slug,\n        p.name,\n        p.description,\n        p.price,\n        p.image_url,\n        s.slug AS subcategory_slug,\n        c.slug AS category_slug\n      FROM products p\n      JOIN subcategories s\n        ON p.subcategory_slug = s.slug\n      JOIN subcollections sc\n        ON s.subcollection_id = sc.id\n      JOIN categories c\n        ON sc.category_slug = c.slug\n    `;\n\n    if (searchTerm.length <= 2) {\n      const { rows } = await pool.query(\n        `\n        ${baseQuery}\n        WHERE p.name ILIKE $1\n        LIMIT 5\n        `,\n        [`${searchTerm}%`],\n      );\n      return rows;\n    }\n\n    const tsQuery = searchTerm\n      .split(\" \")\n      .filter(Boolean)\n      .map((t) => `${t}:*`)\n      .join(\" & \");\n\n    const { rows } = await pool.query(\n      `\n      ${baseQuery}\n      WHERE to_tsvector('english', p.name)\n            @@ to_tsquery('english', $1)\n      LIMIT 5\n      `,\n      [tsQuery],\n    );\n\n    return rows;\n  },\n  [\"search-results\"],\n  { revalidate: 60 * 60 * 2 },\n);\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///home/ayan/Programming/NextFasterPostgres/src/app/api/search/route.ts"],"sourcesContent":["import { getSearchResults } from \"@/lib/queries\";\nimport { NextRequest } from \"next/server\";\n\nexport async function GET(request: NextRequest) {\n  // format is /api/search?q=term\n  const searchTerm = request.nextUrl.searchParams.get(\"q\");\n  if (!searchTerm || !searchTerm.length) {\n    return Response.json([]);\n  }\n\n  const results = await getSearchResults(searchTerm);\n\n  console.log(results);\n\n  const searchResults: ProductSearchResult = results.map((item) => {\n    const href = `/products/${item.category_slug}/${item.subcategory_slug}/${item.slug}`;\n    return {\n      ...item.products,\n      href,\n    };\n  });\n  const response = Response.json(searchResults);\n  // cache for 10 minutes\n  response.headers.set(\"Cache-Control\", \"public, max-age=600\");\n  return response;\n}\n\nexport type ProductSearchResult = {\n  href: string;\n  name: string;\n  slug: string;\n  image_url: string | null;\n  description: string;\n  price: string;\n  subcategory_slug: string;\n}[];\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAGO,eAAe,IAAI,OAAoB;IAC5C,+BAA+B;IAC/B,MAAM,aAAa,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;IACpD,IAAI,CAAC,cAAc,CAAC,WAAW,MAAM,EAAE;QACrC,OAAO,SAAS,IAAI,CAAC,EAAE;IACzB;IAEA,MAAM,UAAU,MAAM,IAAA,2IAAgB,EAAC;IAEvC,QAAQ,GAAG,CAAC;IAEZ,MAAM,gBAAqC,QAAQ,GAAG,CAAC,CAAC;QACtD,MAAM,OAAO,CAAC,UAAU,EAAE,KAAK,aAAa,CAAC,CAAC,EAAE,KAAK,gBAAgB,CAAC,CAAC,EAAE,KAAK,IAAI,EAAE;QACpF,OAAO;YACL,GAAG,KAAK,QAAQ;YAChB;QACF;IACF;IACA,MAAM,WAAW,SAAS,IAAI,CAAC;IAC/B,uBAAuB;IACvB,SAAS,OAAO,CAAC,GAAG,CAAC,iBAAiB;IACtC,OAAO;AACT"}}]
}